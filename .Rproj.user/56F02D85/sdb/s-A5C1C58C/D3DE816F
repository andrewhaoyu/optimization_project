{
    "collab_server" : "",
    "contents" : "library(readstata13)\n\nCI95_empircal <- function(post.bounds){\n  x <- post.bounds[,1]\n  y <- post.bounds[,2]\n  max_x <- quantile(x,probs = 0.05)\n  x.seq <- seq(min(x),max_x,0.001)\n  y.seq <- seq(min(y),max(y),0.001)\n  n <- nrow(post.bounds)\n  x.y <- expand.grid(x.seq,y.seq)\n  pdf <- rep(0,nrow((x.y)))\n  colnames(x.y) <- c(\"x\",\"y\")\n  for( i in 1:nrow(x.y)){\n    idx <- which(post.bounds[,1]>=x.y[i,1]&post.bounds[,2]<=x.y[i,2])\n    pdf[i] <- length(idx)/n\n  }\n  result <- data.frame(x.y,pdf=pdf)\n  \n  idx <- which(abs(result$pdf-0.95)<1e-06)\n  differ <- result$y[idx]-result$x[idx]\n  jdx <- which.min(differ)\n  x.y.95 <- cbind(result$x[idx],result$y[idx])\n  if(length(jdx)>1){\n    jdx <- jdx[1]\n  }\n  final <- x.y.95[jdx,]\n  return(final)\n}\n\nstan.model <- \"\ndata {\n\nint<lower=0> N[12];\n}\n\ntransformed data {\n\nvector[15] ones;\n\nfor(i in 1:15){\nones[i] = 1;\n}\n}\n\nparameters {\n\nsimplex[15] p;\nreal<lower=0, upper=1> q;\n\n}\n\ntransformed parameters {\n\nsimplex[12] op;\n\n\n\nop[1] = (1-q)*p[11];\nop[2] = (1-q)*p[12];\nop[3] = (1-q)*p[13];\nop[4] = (1-q)*p[14];\nop[5] = (1-q)*p[15];\nop[6]= (1-q)*(p[1]+p[2]+p[3]+p[4]+p[5]+p[6]+p[7]+p[8]+p[9]+p[10]);\nop[7] = q*(p[11]+p[6]);\nop[8] = q*(p[12]+p[7]);\nop[9] = q*(p[13]+p[8]);\nop[10] = q*(p[14]+p[9]);\nop[11] = q*(p[15]+p[10]);\nop[12] = q*(p[1]+p[2]+p[3]+p[4]+p[5]);\n\n}\n\nmodel {\np  ~ dirichlet(ones);\nq  ~ uniform(0,1);\nN  ~ multinomial(op);\n}\n\ngenerated quantities {\nreal<lower=0, upper=5> tp[7];\nreal bounds[2];\n\n\ntp[1] = (p[11]*1+p[12]*2+p[13]*3+p[14]*4+p[15]*5)/(p[11] + p[12]+p[13]+p[14]+p[15]);\ntp[2] = p[11] + p[12] + p[13] + p[14] + p[15];\ntp[3] = p[1]+p[2]+p[3]+p[4]+p[5] ;\ntp[4] = p[6]+p[7]+p[8]+p[9]+p[10];\ntp[5] = ((p[6]+p[11])+2*(p[7]+p[12])+3*(p[8]+p[13])+4*(p[9]+p[14])+5*(p[10]+p[15]))/(p[5]+p[6]+p[7]+p[8]+p[9]+p[10]+p[11]+p[12]+p[13]+p[14]+p[15]);\ntp[6] = (p[6]+2*p[7]+3*p[8]+4*p[9]+5*p[10])/(p[6]+p[7]+p[8]+p[9]+p[10]);\ntp[7] = 1*(p[1]+p[5]+p[11])+2*(p[2]+p[6]+p[12])+3*(p[3]+p[8]+p[13])+4*(p[4]+p[9]+p[13])+5*(p[5]+p[10]+p[15]);\n\n\n\nbounds[1] = tp[5] * (tp[2] + tp[4]) + tp[3];\nbounds[2] = tp[5] * (tp[2] + tp[4]) + 5*tp[3];\n}\n\n\"\n\n\ncomputebounds <- function(variable){\n  z <- data$randomsample\n  r <- rep(1,nrow(data))\n  idx <- which(is.na(variable))\n  r[idx] <- 0\n  y <- variable\n  data <- cbind(z,r,y)\n  data_count <- table(z,r,y,useNA = \"ifany\")\n  n011 <- data_count[[3]]\n  n111 <- data_count[[4]]\n  n012 <- data_count[[7]]\n  n112 <- data_count[[8]]\n  n013 <- data_count[[11]]\n  n113 <- data_count[[12]]\n  n014 <- data_count[[15]]\n  n114 <- data_count[[16]]\n  n015 <- data_count[[19]]\n  n115 <- data_count[[20]]\n  m00 <- data_count[[21]]\n  m10 <- data_count[[22]]\n  \n  n.obs <- c(n011,n012,n013,n014,n015,m00,n111,n112,n113,n114,n115,m10)\n  \n  rst <- stan(model_code = stan.model,\n              data = list(N=n.obs),\n              iter =35000, warmup = 6000, chains = 5,\n              thin = 5, verbose = TRUE);\n  print(rst);\n  \n  post.p <- extract(rst, \"p\")$p;\n  post.q <- extract(rst, \"q\")$q;\n  post.tp <- extract(rst, \"tp\")$tp;\n  post.bounds <- extract(rst, \"bounds\")$bounds;\n  a <- CI95_empircal(post.bounds)\n  return(a)\n}\nworst.bounds <- function(variable){\n  y <- variable\n  y[is.na(variable)] <- min(variable,na.rm = T)\n  a <- rep(0,2)\n  a[1] <- mean(y)\n  y[is.na(variable)] <- max(variable,na.rm = T)\n  a[2] <- mean(y)\n  return(a)\n}\n\nsetwd(\"./realdata\")\ndata <- read.dta13(\"crisis_study_dataset.dta\")\n\ny.interest <- data[,24:33]\n\ntry <- apply(y.interest,2,is.na)\ntry2 <- apply(y.interest,2,table)\n\n\na.other <- computebounds(data$OTHER)\na.urgent <- computebounds(data$URGENT)\na.sendtoed <- computebounds(data$SENDTOED)\na.apptopen <- computebounds(data$APPTOPEN)\na.emerplan <- computebounds(data$EMERPLAN)\na.crishist <- computebounds(data$CRISHIST)\na.office <- computebounds(data$OFFICE)\na.cristx <- computebounds(data$CRISTX)\na.police <- computebounds(data$POLICE)\na.ed <- computebounds(data$ED)\n",
    "created" : 1484286555923.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2665839791",
    "id" : "D3DE816F",
    "lastKnownWriteTime" : 1484789422,
    "last_content_update" : 1484789422548,
    "path" : "~/Documents/study/advanced_ stat_theory/optimization_project/realdata/realdata.R",
    "project_path" : "realdata/realdata.R",
    "properties" : {
        "tempName" : "Untitled2"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}